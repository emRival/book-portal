<!DOCTYPE html>
<html>

<head>
    <title>IDN BOOK READER</title>
    <!-- Use exact original structure paths -->
    <link rel="stylesheet" href="/css/flipbook.style.css">
    <link rel="stylesheet" href="/css/font-awesome.css">

    <!-- Support for Font Awesome 4 as fallback often used by legacy plugins -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Load essential dependencies -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.min.js"></script>
    <script src="/js/pdf.min.js"></script>
    <script src="/js/three.min.js"></script>
    <script src="/js/flipbook.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #1a1a1a;
        }

        #container {
            width: 100%;
            height: 100%;
        }

        /* Ensure FontAwesome is available globally */
        .fa {
            font-family: FontAwesome !important;
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <script>
        // Safety patch for legacy library constants and promise support
        (function () {
            if (window.pdfjsLib) {
                if (!window.pdfjsLib.LinkTarget) {
                    window.pdfjsLib.LinkTarget = { NONE: 0, SELF: 1, BLANK: 2, PARENT: 3, TOP: 4 };
                }
                const originalGetDocument = window.pdfjsLib.getDocument;
                window.pdfjsLib.getDocument = function () {
                    const task = originalGetDocument.apply(this, arguments);
                    if (task && !task.then && task.promise) {
                        task.then = function (onSuccess, onFailure) {
                            return this.promise.then(onSuccess, onFailure);
                        };
                    }
                    return task;
                };
            }
        })();

        const params = new URLSearchParams(window.location.search);
        const pdfUrl = params.get('pdf');
        const slug = params.get('slug');

        if (pdfUrl) {
            $(document).ready(function () {
                // Restore last read page from localStorage
                const progressKey = `lastPage_${slug}`;
                const savedPage = localStorage.getItem(progressKey);
                // The library uses 1-indexed pages for startPage usually if e=1 is first page
                const startPage = savedPage ? parseInt(savedPage, 10) : 1;

                console.log("Initializing flipbook for", slug, "starting at", startPage);

                const flipbook = $("#container").flipBook({
                    pdfUrl: pdfUrl,
                    lightBox: false,
                    layout: 3,
                    zoomMin: 0.8,
                    startPage: startPage, // Load the saved page
                    pdfWorkerSrc: '/js/pdf.worker.min.js',
                    currentPage: { vAlign: "bottom", hAlign: "left" },
                    btnShare: { enabled: false },
                    btnPrint: { hideOnMobile: true },
                    btnDownloadPdf: { enabled: true, url: pdfUrl },
                    backgroundColor: "#1a1a1a",
                    // Performance Boosts
                    webgl: true,              // Use GPU acceleration
                    pageTextureSize: 1024,    // Optimize RAM usage
                    loadAllPages: false,      // Do NOT load everything at once
                    lazyLayer: true,          // Render only visible layers
                    pdfIncrementalLoading: true, // Load PDF in chunks
                    assets: {
                        preloader: "/images/preloader.jpg",
                        overlay: "/images/overlay.png",
                        flipMp3: "/mp3/turnPage.mp3",
                    }
                });

                // The 'pagechange' event is triggered on the FLIPBOOK.Main instance (the return value)
                if (flipbook) {
                    $(flipbook).on('pagechange', function (e) {
                        console.log("Page changed to:", e.page);
                        if (e.page && slug) {
                            localStorage.setItem(progressKey, e.page);
                        }
                    });
                }

                // Fallback: Also try to catch it on the container just in case
                $("#container").on('pagechange', function (e) {
                    console.log("Page changed (container listener):", e.page);
                    if (e.page && slug) {
                        localStorage.setItem(progressKey, e.page);
                    }
                });

                // Extreme Fallback: Polling (Every 2 seconds)
                setInterval(function () {
                    if (flipbook && flipbook.currentPageValue && slug) {
                        const currentPage = flipbook.currentPageValue;
                        if (localStorage.getItem(progressKey) !== String(currentPage)) {
                            console.log("Polling saved page:", currentPage);
                            localStorage.setItem(progressKey, currentPage);
                        }
                    }
                }, 2000);
            });
        }
    </script>
</body>

</html>